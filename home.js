// ===== Config =====
const SHEET_ID  = "1agyu31GI2YGD-42in3P7hZytsKNO-kg-JDdfvlJL7q0";
const TABS      = ["000","100","200","300","400","500","600","700","800","900"];
const LABELS    = {
  "000":"р╕Др╕зр╕▓р╕бр╕гр╕╣р╣Йр╕Чр╕▒р╣Ир╕зр╣Др╕Ы","100":"р╕Ир╕┤р╕Хр╕зр╕┤р╕Чр╕вр╕▓","200":"р╕ир╕▓р╕кр╕Щр╕▓","300":"р╕кр╕▒р╕Зр╕Др╕бр╕ир╕▓р╕кр╕Хр╕гр╣М","400":"р╕ар╕▓р╕йр╕▓",
  "500":"р╕зр╕┤р╕Чр╕вр╕▓р╕ир╕▓р╕кр╕Хр╕гр╣М","600":"р╕зр╕┤р╕Чр╕вр╕▓р╕ир╕▓р╕кр╕Хр╕гр╣Мр╕Ыр╕гр╕░р╕вр╕╕р╕Бр╕Хр╣М","700":"р╕ир╕┤р╕ер╕Ыр╕░р╣Бр╕ер╕░р╕Щр╕▒р╕Щр╕Чр╕Щр╕▓р╕Бр╕▓р╕г","800":"р╕зр╕гр╕гр╕Ур╕Бр╕гр╕гр╕б","900":"р╕ар╕╣р╕бр╕┤р╕ир╕▓р╕кр╕Хр╕гр╣М/р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕ир╕▓р╕кр╕Хр╕гр╣М"
};
const ICONS = {
  "REC":"ЁЯМЯ",
  "NEW":"ЁЯЖХ",
  "000":"ЁЯУШ",  // р╕Др╕зр╕▓р╕бр╕гр╕╣р╣Йр╕Чр╕▒р╣Ир╕зр╣Др╕Ы
  "100":"ЁЯза",  // р╕Ир╕┤р╕Хр╕зр╕┤р╕Чр╕вр╕▓
  "200":"ЁЯЫХ",  // р╕ир╕▓р╕кр╕Щр╕▓
  "300":"ЁЯМР",  // р╕кр╕▒р╕Зр╕Др╕бр╕ир╕▓р╕кр╕Хр╕гр╣М
  "400":"ЁЯФд",  // р╕ар╕▓р╕йр╕▓
  "500":"ЁЯФм",  // р╕зр╕┤р╕Чр╕вр╕▓р╕ир╕▓р╕кр╕Хр╕гр╣М
  "600":"ЁЯЫая╕П",  // р╕зр╕┤р╕Чр╕вр╕▓р╕ир╕▓р╕кр╕Хр╕гр╣Мр╕Ыр╕гр╕░р╕вр╕╕р╕Бр╕Хр╣М
  "700":"ЁЯОи",  // р╕ир╕┤р╕ер╕Ыр╕░р╣Бр╕ер╕░р╕Щр╕▒р╕Щр╕Чр╕Щр╕▓р╕Бр╕▓р╕г
  "800":"ЁЯУЦ",  // р╕зр╕гр╕гр╕Ур╕Бр╕гр╕гр╕б
  "900":"ЁЯЧ║я╕П"   // р╕ар╕╣р╕бр╕┤р╕ир╕▓р╕кр╕Хр╕гр╣М/р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕ир╕▓р╕кр╕Хр╕гр╣М
};

// р╕кр╕╡р╕Ир╕╕р╕Фр╕лр╕▒р╕зр╣Ар╕гр╕╖р╣Ир╕нр╕Зр╣Бр╕вр╕Бр╕лр╕бр╕зр╕Фр╕Щр╕┤р╕Ф р╣Ж
const DOTS = {
  "REC":"gold","NEW":"#ffd166",
  "000":"#06b6d4",   // тЮЬ р╕Яр╣Йр╕▓р╕нр╕бр╣Ар╕Вр╕╡р╕вр╕з (teal)
  "100":"#8b5cf6",   // тЮЬ р╕бр╣Ир╕зр╕З (violet) << р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕Ир╕▓р╕Бр╕Яр╣Йр╕▓р╣Ар╕Фр╕┤р╕б
  "200":"#f59e0b","300":"#10b981","400":"#fb7185",
  "500":"#3b82f6","600":"#f43f5e","700":"#fbbf24",
  "800":"#a78bfa","900":"#84cc16"
};

// ===== UTIL =====
const q = (s, el=document)=>el.querySelector(s);
const el = (tag, attrs={}) => Object.assign(document.createElement(tag), attrs);

// р╕Чр╕│р╕кр╕╡р╣Ар╕Вр╣Йр╕б/р╕нр╣Ир╕нр╕Щр╣Др╕Фр╣Йр╕Ир╕▓р╕Б hex р╣Ар╕Кр╣Ир╕Щ shade('#60a5fa', -20)
function shade(hex, percent){
  try{
    const f = parseInt(hex.replace('#',''),16);
    const t = percent < 0 ? 0 : 255;
    const p = Math.abs(percent)/100;
    const R = f>>16, G = f>>8 & 0x00FF, B = f & 0x0000FF;
    const to = (c)=>Math.round((t-c)*p)+c;
    return "#" + (0x1000000 + (to(R))*0x10000 + (to(G))*0x100 + (to(B))).toString(16).slice(1);
  }catch(e){ return hex; }
}

function shuffle(arr){
  // FisherтАУYates
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function csvUrl(tab){
  // endpoint р╕бр╕▓р╕Хр╕гр╕Рр╕▓р╕Щр╕Вр╕нр╕З Google Sheets CSV
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tab)}&cache=${Date.now()}`;
}
function normKey(s){ return (s||"").replace(/[\u200B-\u200D\uFEFF]/g,"").replace(/\s+/g,"").trim(); }
function mapRow(row){
  const want = {
    "р╕ер╕│р╕Фр╕▒р╕Ъ":"р╕ер╕│р╕Фр╕▒р╕Ъ","р╕Кр╕╖р╣Ир╕нр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н":"р╕Кр╕╖р╣Ир╕нр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н","р╕Ьр╕╣р╣Йр╣Бр╕Хр╣Ир╕З":"р╕Ьр╕╣р╣Йр╣Бр╕Хр╣Ир╕З",
    "р╣Ар╕ер╕Вр╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣И":"р╣Ар╕ер╕Вр╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣И","р╕Др╕│р╕нр╕Шр╕┤р╕Ър╕▓р╕в":"р╕Др╕│р╕нр╕Шр╕┤р╕Ър╕▓р╕в",
    "р╕гр╕╣р╕Ыр╕Ыр╕Б":"р╕гр╕╣р╕Ыр╕Ыр╕Б","audio_url":"audio_url","р╕Др╕░р╣Бр╕Щр╕Щ":"р╕Др╕░р╣Бр╕Щр╕Щ","р╕кр╕Цр╕▓р╕Щр╕░":"р╕кр╕Цр╕▓р╕Щр╕░"
  };
  const out = {}, wn = {};
  Object.keys(want).forEach(k => wn[normKey(k)] = want[k]);
  for(const k in row){ 
    if (/р╕кр╕Цр╕▓р╕Щр╕░/.test(k)) { 
      out["р╕кр╕Цр╕▓р╕Щр╕░"] = (row[k] ?? "").toString().trim(); 
      continue; 
    }
    const kn = normKey(k);
    const t  = wn[kn];
    if (t) out[t] = (row[k] ?? "").toString().trim();
  }
  return out;
}
function statusInfo(v){
  const s = String(v||"").trim();
  if (s==="1") return { text:"р╕зр╣Ир╕▓р╕З", cls:"ok" };
  if (s==="0") return { text:"р╕вр╕╖р╕б", cls:"busy" };
  if (s==="3") return { text:"р╕Лр╣Ир╕нр╕б", cls:"repair" };
  return { text:"-", cls:"na" };
}

const star = n => "тШЕ".repeat(Number(n||0)).padEnd(5, "тШЖ");

// ===== HERO demo banners (р╕Ир╕░р╣Гр╕Кр╣Йр╕Ыр╕Бр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕нр╕Чр╣Зр╕нр╕Ыр╕Ир╕▓р╕Бр╕Ър╕▓р╕Зр╕лр╕бр╕зр╕Фр╕Бр╣Зр╣Др╕Фр╣Й) =====
/* р╣Гр╕Кр╣Йр╣Ар╕Ыр╣Зр╕Щр╕кр╕│р╕гр╕нр╕З р╕Цр╣Йр╕▓р╣Вр╕лр╕ер╕Фр╕Ир╕▓р╕Бр╕Кр╕╡р╕Х post р╣Др╕бр╣Ир╣Др╕Фр╣Й */
const HERO_FALLBACK = [
  {img:"img/bgtest.jpg", title:""},
  {img:"img/post2.jpg", title:""},
  {img:"https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1400&auto=format&fit=crop", title:""}
];


// ===== RENDER HERO =====
function renderHero(HERO){
  const wrap    = q("#heroSlides");
  const dots    = q("#heroDots");
  const titleEl = q("#heroTitle");
  const subEl   = q(".hero__subtitle");

  // р╣Ар╕Др╕ер╕╡р╕вр╕гр╣Мр╕Вр╕нр╕Зр╣Ар╕Фр╕┤р╕б (р╕Бр╕▒р╕Щр╕Лр╣Йр╕│р╣Ар╕зр╕ер╕▓р╕гр╕╡р╣Ар╕Яр╕гр╕Кр╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣М)
  if (wrap) wrap.innerHTML = "";
  if (dots) dots.innerHTML = "";

  HERO.forEach((h,i)=>{
    const slide = el("div", { className:"hero__slide" });

    // р╕Цр╣Йр╕▓р╕бр╕╡р╕ер╕┤р╕Зр╕Бр╣М -> р╕лр╣Ир╕нр╕гр╕╣р╕Ыр╕Фр╣Йр╕зр╕в <a> р╣Гр╕лр╣Йр╕Др╕ер╕┤р╕Бр╣Др╕Фр╣Й; р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕бр╕╡ -> р╕зр╕▓р╕Зр╕гр╕╣р╕Ыр╕Хр╕гр╕З р╣Ж
    let host = slide;
    if (h.href){
      const a = el("a", { href:h.href, target:"_blank", rel:"noopener noreferrer", className:"hero__link", draggable:"false" });
      slide.appendChild(a);
      host = a;
  }

    const img = el("img", {
      src: h.img,
      alt: h.title || "",
      loading: "eager",
      referrerPolicy: "no-referrer",
      draggable: "false"
    });

    host.appendChild(img);
    wrap.appendChild(slide);

    const d = el("span"); if(i===0) d.classList.add("active");
    dots.appendChild(d);
  });

  let idx = 0, timer = null;

  function goto(i){
    idx = (i + HERO.length) % HERO.length;
    wrap.style.transform = `translateX(-${idx*100}%)`;
    if (titleEl) titleEl.textContent = HERO[idx].title || "";
    if (subEl)   subEl.textContent   = HERO[idx].subtitle || "";
    dots.querySelectorAll("span").forEach((n,k)=>n.classList.toggle("active", k===idx));
  }

  // р╕Ыр╕╕р╣Ир╕бр╣Ар╕ер╕╖р╣Ир╕нр╕Щ
  q("#prevHero").onclick = ()=>{ goto(idx-1); resetTimer(); };
  q("#nextHero").onclick = ()=>{ goto(idx+1); resetTimer(); };

  // р╕Др╕ер╕┤р╕Бр╕Юр╕╖р╣Йр╕Щр╕Чр╕╡р╣Ир╕Хр╕▒р╕зр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕нр╕ор╕╡р╣Вр╕гр╣И -> р╣Ар╕Ыр╕┤р╕Фр╕ер╕┤р╕Зр╕Бр╣Мр╕Вр╕нр╕Зр╕кр╣Др╕ер╕Фр╣Мр╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щ (р╕Цр╣Йр╕▓р╕бр╕╡)
  const overlay = q(".hero__overlay");
  if (overlay){
    overlay.addEventListener("click",(e)=>{
      if (e.target.closest("#prevHero, #nextHero")) return; // р╣Др╕бр╣Ир╕Чр╕▒р╕Ър╕Ыр╕╕р╣Ир╕б
      const h = HERO[idx];
      if (h && h.href) window.open(h.href, "_blank", "noopener");
    });
  }

  function resetTimer(){
    if (timer) clearInterval(timer);
    timer = setInterval(()=>goto(idx+1), 6000);
  }

  resetTimer();
  goto(0);
}



// ===== р╣Бр╕Чр╕Щр╕Чр╕╡р╣Ир╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╣Ар╕Фр╕┤р╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф =====
async function loadHeroFromPost(){
  const clean = s => String(s ?? "").replace(/[\u200B-\u200D\uFEFF]/g,"").trim();
  const kNorm = s => clean(s).toLowerCase().replace(/\s+/g,"");

  const csv = await fetch(csvUrl("post")).then(r=>r.text());

  // -------- pass 1: р╕бр╕╡ header р╕Ыр╕Бр╕Хр╕┤ --------
  const p1 = Papa.parse(csv, { header:true, skipEmptyLines:true });
  let items = (p1.data || []).map(scanRow).filter(Boolean);
  if (items.length){
    console.log("HERO items:", items);
    return items;
  }

  // -------- pass 2: р╣Др╕бр╣Ир╕бр╕╡/р╣Ар╕Юр╕╡р╣Йр╕вр╕Щ header -> р╕лр╕▓р╣Бр╕Цр╕зр╕лр╕▒р╕зр╣Ар╕нр╕З --------
  const p2 = Papa.parse(csv, { header:false, skipEmptyLines:true });
  const rows = p2.data || [];

  // р╕лр╕▓ index р╣Бр╕Цр╕зр╕Чр╕╡р╣Ир╕Фр╕╣р╣Ар╕лр╕бр╕╖р╕нр╕Щр╕лр╕▒р╕зр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Чр╕╡р╣Ир╕кр╕╕р╕Ф
  let headIdx = rows.findIndex(row => {
    const cells = (row || []).map(kNorm);
    return cells.some(s =>
      (s.includes("url") && (s.includes("р╕Ыр╕Б") || s.includes("cover"))) ||
      s.includes("р╕гр╕╣р╕Ы") || s.includes("р╕ар╕▓р╕Ю") || s === "cover"
    );
  });
  if (headIdx < 0) headIdx = 0;

  const headers = (rows[headIdx] || []).map(x => kNorm(x));
  for (let i = headIdx + 1; i < rows.length; i++){
    const obj = {};
    (rows[i] || []).forEach((v, idx) => obj[headers[idx] || `c${idx}`] = v);
    const one = scanRow(obj);
    if (one) items.push(one);
  }

  console.log("HERO items:", items);
  return items;

  // ---------- helper: р╕Фр╕╢р╕Зр╕Др╣Ир╕▓р╕Фр╣Йр╕зр╕в fuzzy key ----------
  function scanRow(row){
    if (!row) return null;
    const entries = Object.entries(row);

    const pick = (pred) => {
      for (const [k, v] of entries){
        const kk = kNorm(k);
        if (pred(kk)) return clean(v);
      }
      return "";
    };

    // р╕гр╕╣р╕Ы: р╕вр╕нр╕бр╕гр╕▒р╕Ър╕лр╕▒р╕зр╕Чр╕╡р╣Ир╕бр╕╡ "url"+"р╕Ыр╕Б" р╕лр╕гр╕╖р╕н "р╕гр╕╣р╕Ы"/"р╕ар╕▓р╕Ю"/"cover"
    const img = pick(kk =>
      (kk.includes("url") && (kk.includes("р╕Ыр╕Б") || kk.includes("cover"))) ||
      kk.includes("р╕гр╕╣р╕Ы") || kk.includes("р╕ар╕▓р╕Ю") || kk === "cover"
    );

    if (!/^https?:\/\//i.test(img)) return null; // р╕Хр╣Йр╕нр╕Зр╣Ар╕Ыр╣Зр╕Щр╕ер╕┤р╕Зр╕Бр╣Мр╕Ир╕гр╕┤р╕Зр╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ

    // р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б: р╕вр╕╖р╕Фр╕лр╕вр╕╕р╣Ир╕Щр╕Кр╕╖р╣Ир╕нр╕лр╕▒р╕з
    const title = pick(kk =>kk.includes("р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Ыр╕гр╕░р╕Бр╕▓р╕и") || kk.startsWith("р╕Ыр╕гр╕░р╕Бр╕▓р╕и") || kk.includes("title") || kk.includes("р╕лр╕▒р╕зр╕Вр╣Йр╕н"));
    const sub1  = pick(kk => /(р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕гр╕нр╕З1|р╕гр╕нр╕З1|subtitle1|sub1)/.test(kk));
    const sub2  = pick(kk => /(р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕гр╕нр╕З2|р╕гр╕нр╕З2|subtitle2|sub2)/.test(kk));
    
    const hrefRaw = pick(kk => /(р╕ер╕┤р╣Йр╕З|р╕ер╕┤р╕Зр╕Бр╣М|р╕ер╕┤р╕Зр╕Др╣М|link|href|р╣Др╕Ыр╕Чр╕╡р╣И|target|р╣Др╕Ыр╕вр╕▒р╕З)/.test(kk));
    const href    = (/^https?:\/\//i.test(hrefRaw) && hrefRaw !== img) ? hrefRaw : ""; 

    return { img, title, subtitle: [sub1, sub2].filter(Boolean).join("   "), href };
  }
}



// ===== LOAD ONE TAB =====
function loadTab(tab){
  return new Promise((res, rej)=>{
    Papa.parse(csvUrl(tab), {
      download:true, header:true, skipEmptyLines:true,
      complete: r => res((r.data||[]).map(mapRow)),
      error: rej
    });
  });
}

// ===== SECTION RENDER =====
function section(title, code){
  const sec = el("section", {className:"section"});
  if(code === 'NEW') sec.classList.add('section--featured'); 
  

  const head = el("div", {className:"section__head"});
  const cap  = el("div", {className:"section__title"});

  // р╕кр╕╡р╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕Зр╕Хр╕▓р╕бр╕лр╕бр╕зр╕Ф
  const base = DOTS[code] || "var(--accent)";
  const dark = shade(base, -28);

  // р╣Др╕ер╣Ир╕кр╕╡р╕Юр╕╖р╣Йр╕Щр╕лр╕ер╕▒р╕З + р╕Хр╕▒р╕зр╕нр╕▒р╕Бр╕йр╕гр╕Вр╕▓р╕з
  cap.style.background = `linear-gradient(90deg, ${base}, ${dark})`;
  cap.style.color = "#fff";
  cap.style.border = "none";

  // р╕Ир╕╕р╕Фр╕кр╕╡
  const dot = el("span", {className:"section__dot"});
  dot.style.background = base;

  // р╣Др╕нр╕Др╕нр╕Щр╕лр╕бр╕зр╕Ф
  const ico = el("span", {className:"section__ico", textContent: ICONS[code] || "ЁЯУЪ"});

  // р╕Ыр╣Йр╕▓р╕вр╕Кр╕╖р╣Ир╕н (р╣Вр╕Кр╕зр╣М code р╣Ар╕Йр╕Юр╕▓р╕░ 000тАУ900)
  const isNumCat = /^\d{3}$/.test(code);
  const label = el("span", {className:"section__label"});
  label.textContent = ` ${isNumCat ? code + ' ' : ''}${title}`;

  cap.append(dot, ico, label);

  const more = el("a", {
  className:"section__more",
  href:`cat.html?cat=${code}`,
  textContent:"More тА║"
});
  head.append(cap, more);

  const rail = el("div", {className:"rail", id:`rail-${code}`});
  sec.append(head, rail);
  return {sec, rail};
}


function card(book){
  const href = `book.html?id=${encodeURIComponent(book["р╕ер╕│р╕Фр╕▒р╕Ъ"])}&cat=${encodeURIComponent(getCatCode(book["р╣Ар╕ер╕Вр╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣И"]))}`;
  const a = el("a", { className:"card", href, title:book["р╕Кр╕╖р╣Ир╕нр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н"] });

  // р╕лр╣Ир╕нр╕гр╕╣р╕Ыр╕Фр╣Йр╕зр╕в div р╣Ар╕Юр╕╖р╣Ир╕нр╕зр╕▓р╕З badge р╕Лр╣Йр╕нр╕Щ
  const imgWrap = el("div", { style:"position:relative" });
  const img = el("img", {
    className:"card__cover",
    src:book["р╕гр╕╣р╕Ыр╕Ыр╕Б"]||"",
    alt:book["р╕Кр╕╖р╣Ир╕нр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н"],
    loading:"lazy"
  });

  // р╕Ыр╣Йр╕▓р╕вр╕кр╕Цр╕▓р╕Щр╕░
  const st = statusInfo(book["р╕кр╕Цр╕▓р╕Щр╕░"]);
  const badge = el("span", { className:`badge badge--${st.cls}`, textContent: st.text });
  imgWrap.append(img, badge);

  const box = el("div", { className:"card__meta" });
  box.innerHTML = `
    <div class="card__title">${book["р╕Кр╕╖р╣Ир╕нр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н"]||"р╣Др╕бр╣Ир╕Чр╕гр╕▓р╕Ър╕Кр╕╖р╣Ир╕н"}</div>
    <div class="card__author">${book["р╕Ьр╕╣р╣Йр╣Бр╕Хр╣Ир╕З"]||""}</div>
    
  `;
// тФАтФА р╕Ыр╣Йр╕▓р╕вр╕лр╕бр╕зр╕Ф + р╕Фр╕▓р╕з (р╣Бр╕Цр╕зр╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ) тФАтФА
  const code = getCatCode(book["р╣Ар╕ер╕Вр╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣И"]);
  const base = DOTS[code] || "#94a3b8";

  const row   = el("div",  { className:"card__row" });
  const chip  = el("span", { className:"card__chip", textContent:`р╕лр╕бр╕зр╕Ф ${code}` });
  const dot   = el("span", { className:"card__chip-dot" });
  dot.style.background = base;
  chip.prepend(dot);

  // р╣Бр╕Хр╣Ир╕Зр╕кр╕╡ chip р╕Хр╕▓р╕бр╕лр╕бр╕зр╕Ф (р╣Вр╕Чр╕Щр╕нр╣Ир╕нр╕Щр╕нр╣Ир╕▓р╕Щр╕Зр╣Ир╕▓р╕в)
  chip.style.borderColor = base + "55";
  chip.style.background  = base + "14";

  const stars = el("div", { className:"card__stars", textContent: star(book["р╕Др╕░р╣Бр╕Щр╕Щ"]) });

  row.append(chip, stars);
  box.append(row);
  a.append(imgWrap, box);

  return a;
}


// р╕Фр╕╢р╕Зр╕лр╕ер╕▒р╕Бр╕гр╣Йр╕нр╕вр╕Ир╕▓р╕Бр╣Ар╕ер╕Вр╕лр╕бр╕зр╕Ф
function getCatCode(callNumber){
  const m = String(callNumber||"").match(/\d+(\.\d+)?/);
  if(!m) return "000";
  const n = Math.floor(parseFloat(m[0]));
  return String(Math.floor(n/100)*100).padStart(3,"0");
}

// ===== MAIN =====
(async function(){
  document.getElementById("year").textContent = new Date().getFullYear();
  let heroes = [];
  try { heroes = await loadHeroFromPost(); } catch(e) {}
  renderHero(heroes.length ? heroes : HERO_FALLBACK);
  const main = document.getElementById("sections");

  const {sec, rail} = section('р╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕нр╕бр╕▓р╣Гр╕лр╕бр╣И', 'NEW');
  main.appendChild(sec);
  try{
    const rows = await loadTab("newbook");
    rows.slice(0, 16).forEach(b => rail.appendChild(card(b)));
  }catch(e){ 
    const err = el("div", {style:"color:#f87171;padding:6px 2px"});
      err.textContent = "р╣Вр╕лр╕ер╕Ф тАШр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕нр╕бр╕▓р╣Гр╕лр╕бр╣ИтАЩ р╣Др╕бр╣Ир╣Др╕Фр╣Й";
      sec.appendChild(err);
  }

  {
    const {sec, rail} = section("р╣Бр╕Щр╕░р╕Щр╕│", "REC");
    main.appendChild(sec);
    try{
      const rows = await loadTab("rec");     // << р╕Кр╕╡р╣Йр╣Др╕Ыр╕Чр╕╡р╣Ир╕Кр╕╡р╕Хр╣Гр╕лр╕бр╣И
      rows.slice(0, 16).forEach(b => rail.appendChild(card(b)));
    }catch(e){
      const err = el("div", {style:"color:#f87171;padding:6px 2px"});
      err.textContent = "р╣Вр╕лр╕ер╕Ф тАШр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕нтАЩ р╣Др╕бр╣Ир╣Др╕Фр╣Й";
      sec.appendChild(err);
    }
  }

  for (const tab of TABS){
    // header + rail
    const {sec, rail} = section(LABELS[tab]||tab, tab);
    main.appendChild(sec);

    try{
      const rows = await loadTab(tab);
      // р╣Ар╕ер╕╖р╕нр╕Бр╕бр╕▓р╣Вр╕Кр╕зр╣М 12тАУ16 р╣Ар╕ер╣Ир╕бр╣Бр╕гр╕Б (р╕Цр╣Йр╕▓р╕нр╕вр╕▓р╕Бр╕кр╕╕р╣Ир╕бр╣Гр╕лр╣Йр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ logic р╣Др╕Фр╣Й)
      shuffle(rows);
      rows.slice(0, 16).forEach(b => rail.appendChild(card(b)));
    }catch(e){
      const err = el("div", {style:"color:#f87171;padding:6px 2px"}); 
      err.textContent = "р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╣Др╕Фр╣Й";
      sec.appendChild(err);
    }
  }
})();
